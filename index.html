<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2026í•™ë…„ë„ í•™ì‚¬ì¼ì •</title>
  <style>
    :root{
      /* Light only */
      --bg:#ffffff;
      --panel:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#d1d5db;

      --accent:#2563eb;
      --accent2:#16a34a;
      --warn:#d97706;
      --bad:#dc2626;

      --chipBg:#f1f5f9;
      --cellBg:#ffffff;
      --cellAlt:#fafafa;
      --barBg:#eef2ff;

      --shadow: 0 10px 30px rgba(15,23,42,.08);

      /* compact fonts */
      --fs-body:14px;
      --fs-h1:18px;
      --fs-sub:12px;
      --fs-ui:12px;
      --fs-dow:12px;
      --fs-day:11px;
      --fs-bar:11px;
      --fs-mini:11px;

      /* today highlight */
      --today:#BDC0C0;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: var(--fs-body);
    }

    /* Mobile: not sticky (scrolls away) */
    header{
      position: static;
      background: var(--bg);
      border-bottom:1px solid var(--line);
      z-index:10;
    }
    /* Desktop: sticky */
    @media (min-width: 980px){
      header{ position: sticky; top:0; }
    }

    .wrap{max-width:1200px; margin:0 auto; padding:14px;}
    .title{display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;}
    h1{margin:0; font-size:var(--fs-h1); letter-spacing:-.3px;}
    .sub{margin:0; color:var(--muted); font-size:var(--fs-sub)}

    .toolbar{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .btn{
      border:1px solid var(--line);
      background: transparent;
      color:var(--text);
      padding:9px 11px;
      border-radius:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      font-size: var(--fs-ui);
      white-space:nowrap;
    }
    .btn:hover{opacity:.92}
    .btn:active{transform: translateY(1px)}
    .btn.small{padding:7px 9px; border-radius:10px; font-size: var(--fs-ui)}
    .btn.primary{
      border-color: color-mix(in oklab, var(--accent) 55%, var(--line));
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 12%, transparent) inset;
    }

    .input, select{
      border:1px solid var(--line);
      background: transparent;
      color:var(--text);
      padding:9px 11px;
      border-radius:12px;
      outline:none;
      font-size: var(--fs-ui);
      max-width: 360px;
    }
    .input::placeholder{color:var(--muted)}
    option{color:#111827}

    main .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      padding:14px;
    }
    @media (max-width: 980px){ main .grid{grid-template-columns:1fr} }

    .card{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      overflow: visible;
      box-shadow: var(--shadow);
    }

    .monthbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      flex-wrap:wrap;
    }
    .monthbar .m{font-weight:800; letter-spacing:-.3px}

    .chips{display:flex; gap:8px; flex-wrap:wrap; padding:12px 14px 0 14px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--chipBg) 85%, transparent);
      color: var(--muted);
      font-size: var(--fs-ui);
      cursor:pointer;
      white-space:nowrap;
    }
    .chip b{color:var(--text); font-weight:700}
    .chip.active{
      color:var(--text);
      border-color: color-mix(in oklab, var(--accent) 60%, var(--line));
      background: color-mix(in oklab, var(--accent) 14%, transparent);
    }

    .calendar{padding:14px;}

    /* Table-like calendar */
    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:0;
      border:1px solid var(--line);
      border-bottom:0;
      border-radius:14px 14px 0 0;
      overflow:hidden;
    }
    .dow div{
      padding:10px 10px;
      font-size: var(--fs-dow);
      color:var(--muted);
      border-right:1px solid var(--line);
      background: var(--cellAlt);
    }
    .dow div:last-child{border-right:0}

    .weeks{
      border:1px solid var(--line);
      border-top:0;
      border-radius:0 0 14px 14px;
      overflow:hidden;
    }

    .week{
      position:relative;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:0;
      border-top:1px solid var(--line);
      background: var(--cellBg);
    }
    .week:first-child{border-top:0}

    .cell{
      position:relative;
      min-height:112px;
      padding:10px;
      border-right:1px solid var(--line);
      background: var(--cellBg);
      overflow:hidden;
    }
    .cell:nth-child(odd){background: var(--cellAlt)}
    .cell:last-child{border-right:0}
    .cell.muted{opacity:.45}

    /* âœ… ì˜¤ëŠ˜ ë‚ ì§œ ì¹¸ */
    .cell.today{
      background: var(--today) !important;
    }

    .cellTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size: var(--fs-day);
      color:var(--muted);
      margin-bottom:8px;
    }
    .cellTop .dayNum{font-weight:800; color: #111827;}
    .cell.muted .cellTop .dayNum{color: #6b7280;}

    .cellList{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    /* Single-day in-cell */
    .mini{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid color-mix(in oklab, var(--line) 70%, transparent);
      background: color-mix(in oklab, var(--barBg) 55%, transparent);
      font-size: var(--fs-mini);
      overflow:hidden;
      white-space:nowrap;
    }
    .mini .dot{width:8px; height:8px; border-radius:50%}
    .mini .t{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      color:var(--text);
      font-weight:600;
    }

    /* âœ… Ribbon grid overlay */
    .bars{
      position:absolute;
      left:0; right:0;
      top:34px;
      padding:0 10px;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows:24px;
      row-gap:6px;
      pointer-events:none;
      z-index:2;
    }
    .bar{
      height:24px;
      border-radius:12px;
      border:1px solid color-mix(in oklab, var(--line) 70%, transparent);
      background: color-mix(in oklab, var(--barBg) 60%, transparent);
      display:flex;
      align-items:center;
      gap:8px;
      padding:0 10px;
      overflow:hidden;
      white-space:nowrap;
      pointer-events:auto;
      z-index:3;
      min-width:0;
      margin:0 2px;
    }
    .bar .dot{width:9px; height:9px; border-radius:50%}
    .bar .txt{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-size: var(--fs-bar);
      font-weight:800;
      color:var(--text);
    }

    /* category colors */
    .cat-í•™ì‚¬ .dot{background: var(--accent)}
    .cat-ìˆ˜ì—… .dot{background: var(--accent2)}
    .cat-ì‹œí—˜ .dot{background: var(--warn)}
    .cat-íœ´ì¼ .dot{background: var(--bad)}

    /* Side list */
    .side h2{margin:0; font-size:15px; padding:14px 14px 0 14px; letter-spacing:-.2px;}
    .side .hint{padding:6px 14px 12px 14px; margin:0; color:var(--muted); font-size:12px}
    .list{padding:14px; display:flex; flex-direction:column; gap:10px}

    .item{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: var(--cellAlt);
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .item .left{min-width:0}
    .item .row1{
      font-weight:800;
      letter-spacing:-.2px;
      word-break:keep-all;
    }
    .item .row2{
      color:var(--muted);
      font-size:12px;
      margin-top:4px;
      word-break:break-word;
    }

    .footer{
      max-width:1200px; margin:0 auto;
      padding:0 16px 24px;
      color:var(--muted);
      font-size:12px;
    }

    @media print{
      header, .toolbar, .chips {display:none !important}
      body{background:#fff; color:#000}
      .card{box-shadow:none; background:#fff; border:1px solid #ddd}
      .week,.cell{background:#fff}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>2026í•™ë…„ë„ í•™ì‚¬ì¼ì •</h1>
        <!-- âœ… ë¬¸êµ¬ ì œê±°ë¨ (subëŠ” ê°„ë‹¨íˆ) -->
        <p class="sub"></p>
      </div>
    </div>

    <div class="toolbar">
      <div class="controls">
        <button class="btn small" id="prevBtn" title="ì´ì „ ë‹¬ (â†)">â—€ï¸ <span>ì´ì „</span></button>
        <!-- âœ… '2026 ì‹œì‘' â†’ ì‹¤ì œ ì˜¤ëŠ˜ ë‚ ì§œ ë²„íŠ¼ -->
        <button class="btn small" id="todayBtn" title="ì˜¤ëŠ˜ë¡œ ì´ë™">â— <span id="todayLabel">ì˜¤ëŠ˜</span></button>
        <button class="btn small" id="nextBtn" title="ë‹¤ìŒ ë‹¬ (â†’)"><span>ë‹¤ìŒ</span> â–¶ï¸</button>

        <!-- âœ… ì›” ì„ íƒ: 'ì „ì²´' í¬í•¨ -->
        <select id="monthSelect" title="ì›” ì„ íƒ"></select>

        <select id="catSelect" title="ë¶„ë¥˜ í•„í„°">
          <option value="ALL">ì „ì²´ ë¶„ë¥˜</option>
        </select>

        <!-- âœ… ê²€ìƒ‰ + í•™ë…„ í•„í„°(ì˜†) -->
        <input id="q" class="input" placeholder="ê²€ìƒ‰: ì˜ˆ) 6ì›” 15ì¼ | ì¼ì •ëª… / ì„¤ëª…" />
        <select id="gradeSelect" title="í•™ë…„ í•„í„°">
          <option value="ALL">ì „ì²´</option>
          <option value="1">1í•™ë…„</option>
          <option value="2">2í•™ë…„</option>
          <option value="3">3í•™ë…„</option>
        </select>
      </div>

      <div class="controls">
        <button class="btn" id="exportBtn" title="í˜„ì¬ í•„í„° ê²°ê³¼ë¥¼ CSVë¡œ ì €ì¥">â¤“ CSV</button>
        <button class="btn primary" id="printBtn" title="ì¸ì‡„/ì €ì¥ (Ctrl+P)">ğŸ–¨ ì¸ì‡„</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">
      <section class="card">
        <div class="monthbar">
          <div class="m" id="monthTitle">2026.03</div>
          <div style="color:var(--muted); font-size:12px;">
            ë‹¨ì¶•í‚¤: â† â†’
          </div>
        </div>

        <div class="chips" id="summaryChips"></div>

        <div class="calendar">
          <div class="dow" id="dow"></div>
          <div class="weeks" id="weeks"></div>
        </div>
      </section>

      <aside class="card side">
        <h2>ì¼ì • ëª©ë¡</h2>
        <p class="hint">í‘œì‹œ í˜•ì‹: <b>ëª‡ì›” ëª‡ì¼ | ì´ë¦„ / ì„¤ëª…</b></p>
        <div class="list" id="list"></div>
      </aside>
    </div>
  </div>
</main>

<!-- âœ… í•˜ë‹¨ ì•ˆë‚´ë¬¸ ì œê±° -->
<script>
/** =========================================================
 *  EVENTS ë°ì´í„°
 *  - ë‹¨ì¼ì¼: { date:"YYYY-MM-DD", title, category, note?, grade? }
 *  - ê¸°ê°„ì¼ì •: { start:"YYYY-MM-DD", end:"YYYY-MM-DD", title, category, note?, grade? }
 *
 *  grade:
 *    - "1" | "2" | "3" (í•™ë…„ë³„ ì¼ì •)
 *    - ìƒëµ ë˜ëŠ” "ALL" (ì „ì²´ ê³µí†µ)
 * ========================================================= */
const EVENTS = [
  { date:"2026-03-02", title:"1í•™ê¸° ê°œê°•(ì˜ˆì‹œ)", category:"í•™ì‚¬", note:"í•™êµ ê³µì§€ ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ì •", grade:"ALL" },
  { date:"2026-04-20", title:"ì¤‘ê°„ê³ ì‚¬(ì˜ˆì‹œ)", category:"ì‹œí—˜", note:"í•™êµë³„ ì¼ì • ìƒì´", grade:"ALL" },
  { date:"2026-06-15", title:"ê¸°ë§ê³ ì‚¬(ì˜ˆì‹œ)", category:"ì‹œí—˜", note:"í•™êµë³„ ì¼ì • ìƒì´", grade:"ALL" },
  { date:"2026-06-26", title:"1í•™ê¸° ì¢…ê°•(ì˜ˆì‹œ)", category:"í•™ì‚¬", note:"", grade:"ALL" },

  { date:"2026-09-01", title:"2í•™ê¸° ê°œê°•(ì˜ˆì‹œ)", category:"í•™ì‚¬", note:"", grade:"ALL" },
  { date:"2026-10-19", title:"ì¤‘ê°„ê³ ì‚¬(ì˜ˆì‹œ)", category:"ì‹œí—˜", note:"", grade:"ALL" },
  { date:"2026-12-14", title:"ê¸°ë§ê³ ì‚¬(ì˜ˆì‹œ)", category:"ì‹œí—˜", note:"", grade:"ALL" },
  { date:"2026-12-23", title:"2í•™ê¸° ì¢…ê°•(ì˜ˆì‹œ)", category:"í•™ì‚¬", note:"", grade:"ALL" },

  { date:"2026-05-05", title:"ì–´ë¦°ì´ë‚ (ì˜ˆì‹œ)", category:"íœ´ì¼", note:"", grade:"ALL" },

  /* âœ… ìš”ì²­: 6/1~7/14 3í•™ë…„ ì²´í—˜í•™ìŠµ (í•™ë…„=3) */
  { start:"2026-06-01", end:"2026-07-14", title:"3í•™ë…„ ì²´í—˜í•™ìŠµ", category:"í•™ì‚¬", note:"ê¸°ê°„ ì¼ì •", grade:"3" },
];

/** =========================================================
 *  ë²”ìœ„: 2026í•™ë…„ë„(í•„ìš” ì‹œ ì¡°ì •)
 * ========================================================= */
const START_MONTH = "2026-03-01";
const END_MONTH   = "2027-02-01";

/** =========================================================
 *  Util
 * ========================================================= */
const DOW = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
function pad2(n){ return String(n).padStart(2,"0"); }
function toISODate(d){
  const y=d.getFullYear(), m=pad2(d.getMonth()+1), day=pad2(d.getDate());
  return `${y}-${m}-${day}`;
}
function parseISO(iso){
  const [y,m,d]=iso.split("-").map(Number);
  return new Date(y, m-1, d);
}
function ymKey(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }
function formatYM(d){ return `${d.getFullYear()}.${pad2(d.getMonth()+1)}`; }
function formatDateK(iso){
  const [y,m,d]=iso.split("-").map(Number);
  return `${m}ì›” ${d}ì¼`;
}
function formatDateKFull(iso){
  const [y,m,d]=iso.split("-").map(Number);
  return `${y}.${pad2(m)}.${pad2(d)}`;
}
function formatRangeK(s,e){
  return `${formatDateK(s)} ~ ${formatDateK(e)}`;
}
function normalized(s){ return (s||"").toLowerCase().trim(); }
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  })[m]);
}
function clampDateToRange(d){
  const min = new Date(START_MONTH);
  const max = new Date(END_MONTH);
  if(d < min) return min;
  if(d > max) return max;
  return d;
}
function isRange(e){ return !!(e.start && e.end); }
function addDays(dateObj, n){
  const d = new Date(dateObj);
  d.setDate(d.getDate()+n);
  return d;
}
function weekStartOf(dateObj){
  const d = new Date(dateObj);
  const dow = d.getDay();
  d.setDate(d.getDate() - dow);
  d.setHours(0,0,0,0);
  return d;
}
function rangeOverlapsMonth(e, monthDate){
  const ms = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  const me = new Date(monthDate.getFullYear(), monthDate.getMonth()+1, 0);
  const a = parseISO(e.start).getTime();
  const b = parseISO(e.end).getTime();
  return a <= me.getTime() && b >= ms.getTime();
}

/** =========================================================
 *  State
 * ========================================================= */
let state = {
  cursor: new Date(START_MONTH),
  cat: "ALL",
  q: "",
  month: ymKey(new Date(START_MONTH)),
  grade: "ALL", // 1 / 2 / 3 / ALL
};

const els = {
  monthTitle: document.getElementById("monthTitle"),
  dow: document.getElementById("dow"),
  weeks: document.getElementById("weeks"),
  list: document.getElementById("list"),
  monthSelect: document.getElementById("monthSelect"),
  catSelect: document.getElementById("catSelect"),
  q: document.getElementById("q"),
  gradeSelect: document.getElementById("gradeSelect"),
  summaryChips: document.getElementById("summaryChips"),
  todayBtn: document.getElementById("todayBtn"),
  todayLabel: document.getElementById("todayLabel"),
};

/** =========================================================
 *  MonthSelect: includes "ALL"
 * ========================================================= */
function buildMonthOptions(){
  const start = new Date(START_MONTH);
  const end = new Date(END_MONTH);
  const opts = [];
  opts.push({ value: "ALL", label: "ì „ì²´" });

  const d = new Date(start);
  d.setDate(1);
  while(d <= end){
    opts.push({ value: ymKey(d), label: formatYM(d) });
    d.setMonth(d.getMonth()+1);
  }
  els.monthSelect.innerHTML = opts.map(o=>`<option value="${o.value}">${o.label}</option>`).join("");
}

/** =========================================================
 *  Categories
 * ========================================================= */
function getCategories(){
  return Array.from(new Set(EVENTS.map(e=>e.category))).sort((a,b)=>a.localeCompare(b,"ko"));
}
function buildCategoryOptions(){
  const cats = getCategories();
  els.catSelect.innerHTML =
    `<option value="ALL">ì „ì²´ ë¶„ë¥˜</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join("");
}

/** =========================================================
 *  Filtering
 * ========================================================= */
function matchesGrade(e){
  const g = (e.grade || "ALL").toString();
  return state.grade === "ALL" || g === "ALL" || g === state.grade;
}
function getFilteredEvents(){
  const q = normalized(state.q);

  return EVENTS
    .slice()
    .sort((a,b)=>{
      const da = isRange(a) ? a.start : a.date;
      const db = isRange(b) ? b.start : b.date;
      return da.localeCompare(db);
    })
    .filter(matchesGrade)
    .filter(e => state.cat==="ALL" ? true : e.category===state.cat)
    .filter(e => {
      if(!q) return true;
      const datePart = isRange(e) ? `${e.start} ${e.end}` : e.date;
      const pretty = isRange(e) ? formatRangeK(e.start,e.end) : formatDateK(e.date);
      const hay = [
        datePart, pretty,
        e.title, e.note, e.category,
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
}

/** =========================================================
 *  Month / ALL selection logic
 * ========================================================= */
function eventsForList(){
  const all = getFilteredEvents();

  if(state.month === "ALL"){
    return all;
  }
  // month-specific
  const [y,m] = state.month.split("-").map(Number);
  const monthDate = new Date(y, m-1, 1);
  return all.filter(e=>{
    if(isRange(e)) return rangeOverlapsMonth(e, monthDate);
    return (e.date || "").startsWith(state.month);
  });
}

function singleEventsOnDate(iso){
  // periods are shown as ribbons, not minis
  const all = getFilteredEvents();
  if(state.month !== "ALL" && !iso.startsWith(state.month)) return [];
  return all.filter(e=> !isRange(e) && e.date === iso);
}
function rangeEventsForCalendarMonth(monthDate){
  const all = getFilteredEvents();
  return all.filter(e => isRange(e) && rangeOverlapsMonth(e, monthDate));
}

/** =========================================================
 *  Chips summary (based on current selection month or ALL)
 * ========================================================= */
function renderSummaryChips(){
  const list = eventsForList();
  const byCat = {};
  for(const e of list){
    byCat[e.category] = (byCat[e.category]||0)+1;
  }
  const cats = Object.keys(byCat).sort((a,b)=>a.localeCompare(b,"ko"));
  const total = list.length;

  const makeChip = (label, count, active, value) => `
    <div class="chip ${active?'active':''}" data-cat="${escapeHtml(value)}">
      <b>${escapeHtml(label)}</b> ${count}ê±´
    </div>
  `;
  const chips = [];
  chips.push(makeChip("ì „ì²´", total, state.cat==="ALL", "ALL"));
  for(const c of cats){
    chips.push(makeChip(c, byCat[c], state.cat===c, c));
  }
  els.summaryChips.innerHTML = chips.join("");

  els.summaryChips.querySelectorAll(".chip").forEach(ch=>{
    ch.addEventListener("click", ()=>{
      state.cat = ch.dataset.cat;
      els.catSelect.value = state.cat;
      render();
    });
  });
}

/** =========================================================
 *  Ribbon layout (grid-column)
 * ========================================================= */
function splitRangeToWeekSegment(e, weekStartDate){
  const ws = new Date(weekStartDate); ws.setHours(0,0,0,0);
  const we = addDays(ws, 6);

  const a = parseISO(e.start);
  const b = parseISO(e.end);

  const segStart = (a > ws) ? a : ws;
  const segEnd   = (b < we) ? b : we;
  if(segStart > segEnd) return null;

  const colStart = segStart.getDay();
  const colEnd   = segEnd.getDay();
  return { colStart, colEnd };
}

function layoutBarsForWeek(rangeEvents, weekStartDate){
  const segs = [];
  for(const e of rangeEvents){
    const seg = splitRangeToWeekSegment(e, weekStartDate);
    if(seg) segs.push({ ...seg, e });
  }

  segs.sort((x,y)=>{
    if(x.colStart !== y.colStart) return x.colStart - y.colStart;
    return (y.colEnd - y.colStart) - (x.colEnd - x.colStart);
  });

  const rowsEnd = [];
  const placed = [];

  for(const s of segs){
    let rowIndex = -1;
    for(let r=0;r<rowsEnd.length;r++){
      if(s.colStart > rowsEnd[r]){ rowIndex = r; break; }
    }
    if(rowIndex === -1){
      if(rowsEnd.length >= 3) continue;
      rowsEnd.push(-1);
      rowIndex = rowsEnd.length-1;
    }
    rowsEnd[rowIndex] = s.colEnd;
    placed.push({ rowIndex, seg: s });
  }

  return { rowsCount: rowsEnd.length, placed };
}

/** =========================================================
 *  Calendar render
 *  - If monthSelect = ALL, calendar shows current cursor month
 *    (list shows all)
 * ========================================================= */
function renderCalendar(){
  // cursor month for calendar view
  let cur;
  if(state.month === "ALL"){
    cur = new Date(state.cursor);
    cur.setDate(1);
  } else {
    const [y,m] = state.month.split("-").map(Number);
    cur = new Date(y, m-1, 1);
    state.cursor = cur;
  }

  els.monthTitle.textContent = (state.month === "ALL")
    ? `${formatYM(cur)} (ì „ì²´ ì„ íƒ)`
    : formatYM(cur);

  els.monthSelect.value = state.month;

  renderSummaryChips();

  const gridStart = weekStartOf(new Date(cur));
  const rangeEvents = rangeEventsForCalendarMonth(cur);

  const todayISO = toISODate(new Date());

  const weeksHtml = [];
  for(let w=0; w<6; w++){
    const ws = addDays(gridStart, w*7);
    const { rowsCount, placed } = layoutBarsForWeek(rangeEvents, ws);

    let barsHtml = `<div class="bars" style="grid-template-rows: repeat(${Math.max(rowsCount,0)}, 24px);">`;
    for(const p of placed){
      const s = p.seg;
      const e = s.e;
      const title = `${e.title} (${formatDateKFull(e.start)}~${formatDateKFull(e.end)})${e.note? " - "+e.note:""}`;
      const gcStart = s.colStart + 1;
      const gcEnd = s.colEnd + 2;
      const gr = p.rowIndex + 1;
      barsHtml += `
        <div class="bar cat-${escapeHtml(e.category)}"
             style="grid-column:${gcStart} / ${gcEnd}; grid-row:${gr};"
             title="${escapeHtml(title)}">
          <span class="dot"></span>
          <span class="txt">${escapeHtml(e.title)}</span>
        </div>
      `;
    }
    barsHtml += `</div>`;

    let cellsHtml = ``;
    for(let c=0;c<7;c++){
      const d = addDays(ws, c);
      const iso = toISODate(d);
      const inMonth = d.getMonth() === cur.getMonth();
      const singles = singleEventsOnDate(iso);

      const miniItems = singles.slice(0,2).map(ev => `
        <div class="mini cat-${escapeHtml(ev.category)}" title="${escapeHtml(ev.title)}${ev.note ? ' - '+escapeHtml(ev.note) : ''}">
          <span class="dot"></span>
          <span class="t">${escapeHtml(ev.title)}</span>
        </div>
      `).join("");

      const isToday = (iso === todayISO);

      cellsHtml += `
        <div class="cell ${inMonth ? "" : "muted"} ${isToday ? "today" : ""}" data-date="${iso}">
          <div class="cellTop">
            <span class="dayNum">${d.getDate()}</span>
            <span class="cnt">${singles.length ? singles.length+"ê±´" : ""}</span>
          </div>
          <div class="cellList">
            ${miniItems}
          </div>
        </div>
      `;
    }

    weeksHtml.push(`<div class="week">${barsHtml}${cellsHtml}</div>`);
  }

  els.weeks.innerHTML = weeksHtml.join("");

  // click day -> scroll list to that day (only works if list contains that day anchor)
  els.weeks.querySelectorAll(".cell").forEach(cell=>{
    cell.addEventListener("click", ()=>{
      const iso = cell.dataset.date;
      const target = document.querySelector(`[data-item-anchor="${iso}"]`);
      if(target) target.scrollIntoView({behavior:"smooth", block:"center"});
    });
  });
}

/** =========================================================
 *  List render format: "ëª‡ì›” ëª‡ì¼ | ì´ë¦„/ì„¤ëª…"
 *  - month=ALL: show everything sorted
 *  - month=YYYY-MM: show that month
 * ========================================================= */
function renderList(){
  const list = eventsForList();
  if(list.length === 0){
    els.list.innerHTML = `<div style="color:var(--muted); padding:10px 2px;">í‘œì‹œí•  ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  els.list.innerHTML = list.map(e=>{
    const anchor = isRange(e) ? e.start : e.date;
    const datePart = isRange(e)
      ? formatRangeK(e.start, e.end)
      : formatDateK(e.date);

    const desc = (e.note||"").trim();
    const line = desc ? `${e.title} / ${desc}` : `${e.title}`;

    return `
      <div class="item" data-item-anchor="${escapeHtml(anchor)}">
        <div class="left">
          <div class="row1">${escapeHtml(datePart)} | ${escapeHtml(line)}</div>
          <div class="row2">${escapeHtml(e.category)} Â· ${escapeHtml((e.grade||"ALL")==="ALL" ? "ì „ì²´" : e.grade+"í•™ë…„")}</div>
        </div>
      </div>
    `;
  }).join("");
}

/** =========================================================
 *  DOW + options
 * ========================================================= */
function renderDOW(){
  els.dow.innerHTML = DOW.map(x=>`<div>${x}</div>`).join("");
}

/** =========================================================
 *  Render all
 * ========================================================= */
function render(){
  buildCategoryOptions();
  renderCalendar();
  renderList();
}

/** =========================================================
 *  Navigation
 * ========================================================= */
function moveMonth(delta){
  const d = new Date(state.cursor);
  d.setMonth(d.getMonth()+delta);
  d.setDate(1);
  state.cursor = clampDateToRange(d);
  // if currently selecting a specific month, update monthSelect too
  if(state.month !== "ALL"){
    state.month = ymKey(state.cursor);
    els.monthSelect.value = state.month;
  }
  render();
}

/** =========================================================
 *  CSV export (list based on current filters + monthSelect)
 * ========================================================= */
function exportCSV(){
  const rows = [["date_or_range","grade","category","title","note"]];
  const data = eventsForList();
  for(const e of data){
    const d = isRange(e) ? `${e.start}~${e.end}` : e.date;
    rows.push([d, (e.grade||"ALL"), e.category, e.title, e.note||""]);
  }
  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `academic_calendar_2026.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/** =========================================================
 *  Init
 * ========================================================= */
renderDOW();
buildMonthOptions();

const today = new Date();
const todayISO = toISODate(today);
els.todayLabel.textContent = todayISO; // ë²„íŠ¼ ë¼ë²¨: YYYY-MM-DD
// ì´ˆê¸° ì ‘ì† ì‹œ: 2026í•™ë…„ë„ ë²”ìœ„ ë°–ì´ë©´ START_MONTHë¡œ ë³´ì •
state.cursor = clampDateToRange(today);
state.month = ymKey(state.cursor);
els.monthSelect.value = state.month;

document.getElementById("prevBtn").addEventListener("click", ()=>moveMonth(-1));
document.getElementById("nextBtn").addEventListener("click", ()=>moveMonth(+1));
document.getElementById("todayBtn").addEventListener("click", ()=>{
  state.cursor = clampDateToRange(new Date());
  if(state.month !== "ALL") state.month = ymKey(state.cursor);
  render();
});

els.monthSelect.addEventListener("change", (e)=>{
  state.month = e.target.value;
  if(state.month !== "ALL"){
    const [y,m] = state.month.split("-").map(Number);
    state.cursor = clampDateToRange(new Date(y, m-1, 1));
  }
  render();
});

els.catSelect.addEventListener("change", (e)=>{
  state.cat = e.target.value;
  render();
});
els.gradeSelect.addEventListener("change", (e)=>{
  state.grade = e.target.value;
  render();
});
els.q.addEventListener("input", (e)=>{
  state.q = e.target.value;
  render();
});

document.getElementById("exportBtn").addEventListener("click", exportCSV);
document.getElementById("printBtn").addEventListener("click", ()=>window.print());

window.addEventListener("keydown", (e)=>{
  if(e.key==="ArrowLeft") moveMonth(-1);
  if(e.key==="ArrowRight") moveMonth(+1);
});

/** first render */
render();
</script>
</body>
</html>
